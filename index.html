<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工时打卡日历 - 增强统计版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #4cc9f0; --warning: #f72585; --light: #f8f9fa; --dark: #212529;
            --gray: #6c757d; --border: #dee2e6;
            --batch-selected: #e3f2fd; --batch-hover: #bbdefb;
            --chart-bg: #f8fafd;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa, #e4edf9); color: var(--dark); min-height: 100vh; padding: 15px 15px 80px; }
        .container { max-width: 500px; margin: auto; }
        header { background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, .08); padding: 18px 20px; margin-bottom: 20px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .month-year { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .nav-buttons { display: flex; gap: 12px; }
        .btn { background: var(--primary); color: #fff; border: none; border-radius: 12px; padding: 8px 15px; font-size: .9rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: .2s; box-shadow: 0 2px 8px rgba(67, 97, 238, .3); }
        .btn:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn i { margin-right: 6px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
        .btn-outline:hover { background: var(--primary); color: #fff; }
        .btn-warning { background: var(--warning); }
        .btn-warning:hover { background: #d81b60; }
        .tabs { display: flex; background: #f1f5fe; border-radius: 50px; padding: 5px; margin-top: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: .3s; }
        .tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 8px rgba(0, 0, 0, .1); }
        .calendar { background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, .08); overflow: hidden; margin-bottom: 20px; }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--primary); color: #fff; font-weight: 600; text-align: center; padding: 12px 0; }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 10px; background: #f8fafd; }
        .day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; background: #fff; position: relative; cursor: pointer; transition: .2s; font-weight: 600; box-shadow: 0 1px 3px rgba(0, 0, 0, .05); }
        .day:hover { background: #f0f5ff; transform: scale(1.05); }
        .day.other-month { color: var(--gray); opacity: .6; }
        .day.today { background: #e6f0ff; color: var(--primary); font-weight: 700; }
        .day.has-record { background: #f0f8ff; }
        .day.batch-selected { background: var(--batch-selected); box-shadow: inset 0 0 0 2px var(--primary); }
        .day.batch-selected:hover { background: var(--batch-hover); }
        .day-record { font-size: .6rem; color: var(--success); margin-top: 2px; font-weight: 500; }
        .day-holiday { font-size: .55rem; color: #e74c3c; margin-top: 2px; }
        .day-lunar { font-size: .55rem; color: var(--gray); margin-top: 1px; }
        .day-total { font-size: .6rem; font-weight: 600; color: #2196f3; margin-top: 2px; }
        .stats { background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, .08); padding: 20px; margin-bottom: 20px; }
        .stats h3 { margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #f8fafd, #edf3ff); border-radius: 14px; padding: 15px; text-align: center; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin: 5px 0; }
        .stat-card .label { font-size: .85rem; color: var(--gray); }
        
        /* 图表容器样式 */
        .chart-container { background: var(--chart-bg); border-radius: 14px; padding: 15px; margin-bottom: 20px; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-title { font-weight: 600; color: var(--primary); }
        .chart-actions { display: flex; gap: 8px; }
        .chart-btn { background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 0.9rem; }
        .chart-wrapper { height: 250px; position: relative; }
        
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 -4px 15px rgba(0, 0, 0, .08); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 100; }
        .action-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--gray); font-size: .8rem; transition: .2s; }
        .action-btn.active { color: var(--primary); }
        .action-btn i { font-size: 1.4rem; }
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, .7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: .3s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #fff; border-radius: 20px; width: 90%; max-width: 400px; overflow: hidden; transform: translateY(20px); transition: .3s; }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { background: var(--primary); color: #fff; padding: 20px; text-align: center; font-size: 1.2rem; font-weight: 600; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        .modal-footer { display: flex; padding: 0 20px 20px; gap: 10px; }
        .btn-block { display: block; width: 100%; text-align: center; }
        .tabs-inner { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .tab-inner { flex: 1; text-align: center; padding: 10px; cursor: pointer; transition: .2s; }
        .tab-inner.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .shortcut-list { display: flex; flex-direction: column; gap: 10px; }
        .shortcut-item { display: flex; justify-content: space-between; align-items: center; background: #f1f5fe; padding: 10px 15px; border-radius: 10px; }
        .shortcut-item button { background: transparent; border: none; color: red; cursor: pointer; }
        /* 年视图表格 */
        .year-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, .08); }
        .year-table th, .year-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
        .year-table th { background: var(--primary); color: #fff; }
        .year-table tr:last-child td { border-bottom: none; }
        .year-table .btn-outline { margin: 0 3px; }
        .data-preview { background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, .08); padding: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
        .data-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .data-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead th { background: #f1f5fe; padding: 12px 10px; text-align: left; font-weight: 600; color: var(--primary); position: sticky; top: 0; z-index: 1; background-color: #fff; }
        .data-table tbody td { padding: 12px 10px; border-bottom: 1px solid var(--border); }
        .data-table tr:last-child td { border-bottom: none; }
        .del-btn { background: transparent; color: red; border: none; cursor: pointer; }
        .batch-controls { display: flex; justify-content: space-between; background: #f1f5fe; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; }
        .batch-info { font-weight: 600; color: var(--primary); }
        .batch-actions { display: flex; gap: 8px; }
        
        /* 图表详情模态框 */
        .chart-detail-content { display: flex; flex-direction: column; gap: 15px; }
        .detail-item { background: #f8fafd; padding: 15px; border-radius: 10px; }
        .detail-item h4 { margin-bottom: 10px; color: var(--primary); }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .detail-card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); text-align: center; }
        .detail-card .value { font-size: 1.2rem; font-weight: 700; }
        .detail-card .label { font-size: 0.8rem; color: var(--gray); margin-top: 5px; }
        
        /* 退出确认模态框 */
        .exit-confirm-modal .modal-content { max-width: 350px; }
        .exit-confirm-modal .modal-body { text-align: center; }
        .exit-confirm-modal .modal-footer { justify-content: center; }
        
        @media (max-width: 480px) {
            .header-content { flex-direction: column; gap: 12px; }
            .nav-buttons { width: 100%; justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; }
            .data-actions { flex-direction: column; }
            .batch-controls { flex-direction: column; gap: 10px; }
            .chart-wrapper { height: 200px; }
            .detail-grid { grid-template-columns: 1fr; }
        }
        /* 导入数据模态框 */
        .import-btn { background: transparent; color: var(--primary); border: 2px dashed var(--primary); padding: 10px; border-radius: 10px; width: 100%; text-align: center; cursor: pointer; transition: .2s; }
        .import-btn:hover { background: rgba(67, 97, 238, 0.1); }
        .import-btn input { position: absolute; opacity: 0; width: 0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="month-year" id="monthYearText">2023年12月</div>
                <div class="nav-buttons">
                    <button class="btn" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                    <button class="btn" id="todayBtn">今天</button>
                    <button class="btn" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                    <button class="btn" id="batchBtn">批量打卡</button>
                </div>
            </div>
            <div class="tabs">
                <div class="tab active" data-view="month">月视图</div>
                <div class="tab" data-view="year">年视图</div>
                <div class="tab" data-view="data">数据预览</div>
                <div class="tab" data-view="stats">统计</div>
            </div>
        </header>

        <div id="batchControls" class="batch-controls" style="display:none;">
            <div class="batch-info">已选择 <span id="selectedCount">0</span> 天</div>
            <div class="batch-actions">
                <button class="btn btn-outline" id="batchSelectAll">全选</button>
                <button class="btn" id="batchApply">应用快捷打卡</button>
                <button class="btn btn-warning" id="batchCancel">取消</button>
            </div>
        </div>

        <main>
            <!-- 月视图 -->
            <div class="calendar" id="monthView">
                <div class="weekdays"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                <div class="days" id="calendarDays"></div>
            </div>

            <!-- 年视图 -->
            <div class="data-preview" id="yearView" style="display:none;">
                <div class="data-header">
                    <h3>年度打卡数据</h3>
                </div>
                <table class="year-table">
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>正班(小时)</th>
                            <th>加班(小时)</th>
                            <th>周末加班(小时)</th>
                            <th>收入(元)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="yearTableBody"></tbody>
                </table>
            </div>

            <!-- 数据预览 -->
            <div class="data-preview" id="dataView" style="display:none;">
                <div class="data-header">
                    <h3>打卡数据</h3>
                    <div class="data-actions">
                        <button class="btn btn-outline" id="exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
                        <button class="btn btn-outline" id="exportJson"><i class="fas fa-file-code"></i> JSON</button>
                        <button class="btn btn-outline" id="importJson"><i class="fas fa-file-import"></i> 导入 JSON</button>
                        <button class="btn btn-outline" id="clearRecords" style="color:red;border-color:red;"><i class="fas fa-trash"></i> 清除全部</button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>日期</th><th>正班(小时)</th><th>加班(小时)</th><th>周末加班(小时)</th><th>时薪</th><th>日薪</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>

            <!-- 统计 -->
            <div class="stats" id="statsView" style="display:none;">
                <h3><i class="fas fa-chart-bar"></i> 月度统计</h3>
                <div class="stats-grid" id="monthStatsGrid">
                    <div class="stat-card"><div class="value" id="monthDays">0</div><div class="label">打卡天数</div></div>
                    <div class="stat-card"><div class="value" id="monthNormal">0</div><div class="label">正班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthHours">0</div><div class="label">总工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthOvertime">0</div><div class="label">加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthWeekend">0</div><div class="label">周末加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthSalary">¥0</div><div class="label">月薪总额</div></div>
                </div>

                <!-- 月度图表 -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">月度工时分布</div>
                        <div class="chart-actions">
                            <button class="chart-btn" id="chartMonthHours"><i class="fas fa-chart-bar"></i> 工时</button>
                            <button class="chart-btn" id="chartMonthSalary"><i class="fas fa-yen-sign"></i> 薪资</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthHoursChart"></canvas>
                    </div>
                </div>

                <h3 style="margin-top:25px;"><i class="fas fa-chart-line"></i> 年度统计</h3>
                <div class="stats-grid" id="yearStatsGrid">
                    <div class="stat-card"><div class="value" id="yearDays">0</div><div class="label">打卡天数</div></div>
                    <div class="stat-card"><div class="value" id="yearNormal">0</div><div class="label">正班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearHours">0</div><div class="label">总工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearOvertime">0</div><div class="label">加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearWeekend">0</div><div class="label">周末加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearSalary">¥0</div><div class="label">年薪总额</div></div>
                </div>

                <!-- 年度图表 -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">年度工时趋势</div>
                        <div class="chart-actions">
                            <button class="chart-btn" id="chartYearTrend"><i class="fas fa-chart-line"></i> 趋势</button>
                            <button class="chart-btn" id="chartYearCompare"><i class="fas fa-balance-scale"></i> 对比</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="yearTrendChart"></canvas>
                    </div>
                </div>

                <!-- 工时类型分布 -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">工时类型分布</div>
                        <div class="chart-actions">
                            <button class="chart-btn" id="chartPieHours"><i class="fas fa-chart-pie"></i> 工时</button>
                            <button class="chart-btn" id="chartPieSalary"><i class="fas fa-money-bill-wave"></i> 薪资</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="hoursPieChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 底部操作栏 -->
    <div class="action-bar">
        <div class="action-btn active" id="tabCalendar"><i class="fas fa-calendar-alt"></i><span>打卡日历</span></div>
        <div class="action-btn" id="tabQuick"><i class="fas fa-plus-circle"></i><span>快捷打卡</span></div>
    </div>

    <!-- 打卡模态框 -->
    <div class="modal" id="punchModal">
        <div class="modal-content">
            <div class="modal-header"><span id="modalDate">2023年12月15日</span></div>
            <div class="modal-body">
                <!-- 快捷打卡标签 -->
                <div class="tabs-inner">
                    <div class="tab-inner active" data-tab="shortcuts">快捷</div>
                    <div class="tab-inner" data-tab="manual">手动</div>
                </div>

                <!-- 快捷打卡 -->
                <div class="tab-content active" id="shortcutsContent">
                    <div class="shortcut-list" id="shortcutList">
                        <!-- 动态生成 -->
                    </div>
                </div>

                <!-- 手动输入 -->
                <div class="tab-content" id="manualContent">
                    <div class="form-group">
                        <label>正班工时 (小时)</label>
                        <input type="number" id="normalHours" placeholder="0" value="8">
                    </div>
                    <div class="form-group">
                        <label>加班工时 (小时)</label>
                        <input type="number" id="overtimeHours" placeholder="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>周末加班工时 (小时)</label>
                        <input type="number" id="weekendHours" placeholder="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>时薪 (元)</label>
                        <input type="number" id="hourlyWage" placeholder="80" value="80">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelPunch">取消</button>
                <button class="btn" id="savePunch">保存</button>
            </div>
        </div>
    </div>

    <!-- 批量打卡模态框 -->
    <div class="modal" id="batchModal">
        <div class="modal-content">
            <div class="modal-header">批量打卡</div>
            <div class="modal-body">
                <div class="shortcut-list" id="batchShortcutList">
                    <!-- 动态生成快捷方式列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBatch">取消</button>
                <button class="btn" id="applyBatch">应用到选中日期</button>
            </div>
        </div>
    </div>

    <!-- 添加快捷打卡模态框 -->
    <div class="modal" id="quickModal">
        <div class="modal-content">
            <div class="modal-header">添加快捷打卡</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="quickName" placeholder="如：正常班">
                </div>
                <div class="form-group">
                    <label>正班工时 (小时)</label>
                    <input type="number" id="quickNormal" placeholder="0" value="8">
                </div>
                <div class="form-group">
                    <label>加班工时 (小时)</label>
                    <input type="number" id="quickOvertime" placeholder="0" value="0">
                </div>
                <div class="form-group">
                    <label>周末加班工时 (小时)</label>
                    <input type="number" id="quickWeekend" placeholder="0" value="0">
                </div>
                <div class="form-group">
                    <label>时薪 (元)</label>
                    <input type="number" id="quickWage" placeholder="80" value="80">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelQuick">取消</button>
                <button class="btn" id="saveQuick">保存</button>
            </div>
        </div>
    </div>

    <!-- 导入 JSON 模态框 -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">导入打卡数据</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择 JSON 文件</label>
                    <div style="position: relative;">
                        <button class="import-btn">选择文件 <input type="file" id="importFile" accept=".json" /></button>
                    </div>
                    <div id="importFileName" style="margin-top: 10px; color: var(--gray);">未选择文件</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelImport">取消</button>
                <button class="btn" id="confirmImport">导入</button>
            </div>
        </div>
    </div>
    
    <!-- 图表详情模态框 -->
    <div class="modal" id="chartDetailModal">
        <div class="modal-content">
            <div class="modal-header">工时详情</div>
            <div class="modal-body">
                <div class="chart-detail-content">
                    <div class="detail-item">
                        <h4>工时类型: <span id="detailType"></span></h4>
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="value" id="detailHours">0</div>
                                <div class="label">工时(小时)</div>
                            </div>
                            <div class="detail-card">
                                <div class="value" id="detailHoursPercent">0%</div>
                                <div class="label">工时占比</div>
                            </div>
                            <div class="detail-card">
                                <div class="value" id="detailSalary">¥0</div>
                                <div class="label">薪资总额</div>
                            </div>
                            <div class="detail-card">
                                <div class="value" id="detailSalaryPercent">0%</div>
                                <div class="label">薪资占比</div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>详细信息</h4>
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="value" id="detailAvgHourly">¥0</div>
                                <div class="label">平均时薪</div>
                            </div>
                            <div class="detail-card">
                                <div class="value" id="detailDays">0</div>
                                <div class="label">打卡天数</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeChartDetail">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 退出确认模态框 -->
    <div class="modal exit-confirm-modal" id="exitConfirmModal">
        <div class="modal-content">
            <div class="modal-header">确认退出</div>
            <div class="modal-body">
                <p>您确定要离开当前页面吗？</p>
                <p>所有未保存的数据将会丢失！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelExit">取消</button>
                <button class="btn btn-warning" id="confirmExit">确定退出</button>
            </div>
        </div>
    </div>

    <script>
        /* 全局变量 */
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let selectedDate = new Date();
        let records = {};
        let shortcuts = [];
        let holidays = {
            '2023-10-01': '国庆节',
            '2023-10-02': '国庆节',
            '2023-10-03': '国庆节',
            '2023-12-25': '圣诞节'
        };
        let lunars = {
            '2023-10-01': '八月十七',
            '2023-10-02': '八月十八',
            '2023-10-03': '八月十九',
            '2023-12-25': '冬月十三'
        };
        let batchMode = false;
        let selectedDates = new Set();
        
        // 图表实例
        let monthHoursChart = null;
        let yearTrendChart = null;
        let hoursPieChart = null;
        
        // 当前图表详情
        let chartDetail = {
            type: '',
            hours: 0,
            salary: 0,
            days: 0
        };

        /* 本地存储键名 */
        const STORAGE_KEYS = {
            RECORDS: 'punchRecords',
            SHORTCUTS: 'punchShortcuts',
            HOLIDAYS: 'punchHolidays',
            LUNARS: 'punchLunars'
        };

        /* 初始化加载 */
        document.addEventListener('DOMContentLoaded', () => {
            // 添加退出确认功能
            setupExitConfirmation();
            
            loadAll();
            renderCalendar(currentYear, currentMonth);
            renderYearView();
            renderDataPreview();
            renderStats();
            renderShortcuts();
            setupEventListeners();
        });

        /* 设置退出确认 */
        function setupExitConfirmation() {
            // 监听页面离开事件
            window.addEventListener('beforeunload', function (e) {
                // 检查是否有未保存的数据
                if (Object.keys(records).length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                    openModal('exitConfirmModal');
                    return '您确定要离开当前页面吗？所有未保存的数据将会丢失！';
                }
            });
            
            // 监听滑动返回事件（移动端）
            window.addEventListener('popstate', function(e) {
                if (Object.keys(records).length > 0) {
                    e.preventDefault();
                    openModal('exitConfirmModal');
                }
            });
            
            // 退出确认按钮
            document.getElementById('confirmExit').addEventListener('click', () => {
                window.removeEventListener('beforeunload', arguments.callee);
                window.location = 'about:blank';
            });
            
            // 取消退出按钮
            document.getElementById('cancelExit').addEventListener('click', () => {
                closeModal('exitConfirmModal');
            });
        }

        /* 本地存储读取 */
        function loadAll() {
            const storedRecords = localStorage.getItem(STORAGE_KEYS.RECORDS);
            const storedShortcuts = localStorage.getItem(STORAGE_KEYS.SHORTCUTS);
            
            records = storedRecords ? JSON.parse(storedRecords) : {};
            shortcuts = storedShortcuts ? JSON.parse(storedShortcuts) : [];
        }

        /* 本地存储保存 */
        function saveAll() {
            localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(records));
            localStorage.setItem(STORAGE_KEYS.SHORTCUTS, JSON.stringify(shortcuts));
        }

        /* 格式化日期 */
        function formatDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /* 计算总工时 */
        function calculateTotalHours(rec) {
            return (rec.normal || 0) + (rec.overtime || 0) + (rec.weekend || 0);
        }

        /* 渲染月视图 */
        function renderCalendar(year, month) {
            document.getElementById('monthYearText').textContent = `${year}年${month+1}月`;
            const box = document.getElementById('calendarDays');
            box.innerHTML = '';

            const first = new Date(year, month, 1);
            const last = new Date(year, month+1, 0);
            const startDay = first.getDay();
            const prevLast = new Date(year, month, 0).getDate();

            // 上月占位
            for (let i=startDay-1;i>=0;i--) {
                const d = prevLast - i;
                const div = document.createElement('div');
                div.className = 'day other-month';
                div.innerHTML = `<div>${d}</div>`;
                box.appendChild(div);
            }

            // 当月
            const today = new Date();
            const todayStr = formatDate(today);
            
            for (let d=1; d<=last.getDate(); d++) {
                const date = new Date(year, month, d);
                const str = formatDate(date);
                const rec = records[str];

                const div = document.createElement('div');
                div.className = 'day';
                if (str === todayStr) div.classList.add('today');
                if (rec) div.classList.add('has-record');
                
                // 在批量模式下处理选中状态
                if (batchMode && selectedDates.has(str)) {
                    div.classList.add('batch-selected');
                }

                let html = `<div>${d}</div>`;
                if (holidays[str]) html += `<div class="day-holiday">${holidays[str]}</div>`;
                else if (lunars[str]) html += `<div class="day-lunar">${lunars[str]}</div>`;
                
                if (rec) {
                    const totalHours = calculateTotalHours(rec);
                    html += `<div class="day-total">${totalHours}小时</div>`;
                }
                
                div.innerHTML = html;
                
                // 点击事件处理
                div.addEventListener('click', () => {
                    if (batchMode) {
                        toggleDateSelection(str, div);
                    } else {
                        selectedDate = date;
                        openPunchModal(date, rec);
                    }
                });
                
                box.appendChild(div);
            }

            // 下月占位
            const rest = 7 - (startDay + last.getDate()) % 7;
            if (rest < 7) {
                for (let i=1;i<=rest;i++){
                    const div = document.createElement('div');
                    div.className='day other-month';
                    div.innerHTML=`<div>${i}</div>`;
                    box.appendChild(div);
                }
            }
        }

        /* 切换日期选中状态 */
        function toggleDateSelection(dateStr, element) {
            if (selectedDates.has(dateStr)) {
                selectedDates.delete(dateStr);
                element.classList.remove('batch-selected');
            } else {
                selectedDates.add(dateStr);
                element.classList.add('batch-selected');
            }
            document.getElementById('selectedCount').textContent = selectedDates.size;
        }

        /* 进入批量模式 */
        function enterBatchMode() {
            batchMode = true;
            selectedDates.clear();
            document.getElementById('batchControls').style.display = 'flex';
            document.getElementById('batchBtn').textContent = '退出批量';
            document.getElementById('batchBtn').classList.add('btn-warning');
            document.getElementById('selectedCount').textContent = '0';
            renderCalendar(currentYear, currentMonth);
        }

        /* 退出批量模式 */
        function exitBatchMode() {
            batchMode = false;
            selectedDates.clear();
            document.getElementById('batchControls').style.display = 'none';
            document.getElementById('batchBtn').textContent = '批量打卡';
            document.getElementById('batchBtn').classList.remove('btn-warning');
            renderCalendar(currentYear, currentMonth);
        }

        /* 应用批量打卡 */
        function applyBatchPunch(shortcut) {
            selectedDates.forEach(dateStr => {
                records[dateStr] = {
                    normal: shortcut.normal,
                    overtime: shortcut.overtime,
                    weekend: shortcut.weekend,
                    hourlyWage: shortcut.wage
                };
            });
            saveAll();
            renderAll();
            exitBatchMode();
            closeModal('batchModal');
            alert(`已成功为 ${selectedDates.size} 天应用打卡数据`);
        }

        /* 渲染年视图 */
        function renderYearView() {
            const tbody = document.getElementById('yearTableBody');
            tbody.innerHTML = '';
            for (let m=0;m<12;m++) {
                const stats = getMonthStats(currentYear, m);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m+1}月</td>
                    <td>${stats.normalHours}</td>
                    <td>${stats.overtimeHours}</td>
                    <td>${stats.weekendHours}</td>
                    <td>¥${stats.salary}</td>
                    <td>
                        <button class="btn btn-outline" onclick="jumpToMonth(${m})">查看</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        // 跳转到月份
        function jumpToMonth(month) {
            currentMonth = month;
            renderCalendar(currentYear, currentMonth);
            switchView('month');
        }

        /* 渲染数据预览 */
        function renderDataPreview() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML='';
            Object.entries(records).sort((a,b)=>b[0].localeCompare(a[0])).forEach(([date,rec])=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${date}</td>
                    <td>${rec.normal||0}</td>
                    <td>${rec.overtime||0}</td>
                    <td>${rec.weekend||0}</td>
                    <td>${rec.hourlyWage||80}</td>
                    <td>${calculateDaily(rec)}</td>
                    <td><button class="del-btn" data-date="${date}"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('.del-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    if(confirm('确认删除该条记录？')){
                        delete records[btn.dataset.date];
                        saveAll();
                        renderAll();
                    }
                });
            });
        }

        /* 渲染统计 */
        function renderStats() {
            const m = getMonthStats(currentYear, currentMonth);
            document.getElementById('monthDays').textContent = m.days;
            document.getElementById('monthNormal').textContent = m.normalHours;
            document.getElementById('monthHours').textContent = m.normalHours + m.overtimeHours + m.weekendHours;
            document.getElementById('monthOvertime').textContent = m.overtimeHours;
            document.getElementById('monthWeekend').textContent = m.weekendHours;
            document.getElementById('monthSalary').textContent = `¥${m.salary}`;

            const y = getYearStats(currentYear);
            document.getElementById('yearDays').textContent = y.days;
            document.getElementById('yearNormal').textContent = y.normalHours;
            document.getElementById('yearHours').textContent = y.normalHours + y.overtimeHours + y.weekendHours;
            document.getElementById('yearOvertime').textContent = y.overtimeHours;
            document.getElementById('yearWeekend').textContent = y.weekendHours;
            document.getElementById('yearSalary').textContent = `¥${y.salary}`;
            
            // 渲染图表
            renderMonthCharts();
            renderYearTrendChart();
            renderHoursPieChart();
        }

        /* 渲染月度图表 */
        function renderMonthCharts() {
            // 销毁旧图表
            if (monthHoursChart) {
                monthHoursChart.destroy();
            }
            
            const ctx = document.getElementById('monthHoursChart').getContext('2d');
            
            // 获取当前月的每一天数据
            const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
            const dayLabels = [];
            const normalHours = [];
            const overtimeHours = [];
            const weekendHours = [];
            const totalHours = [];
            
            for (let d=1; d<=daysInMonth; d++) {
                dayLabels.push(`${d}日`);
                const date = new Date(currentYear, currentMonth, d);
                const str = formatDate(date);
                const rec = records[str] || {normal:0, overtime:0, weekend:0};
                
                normalHours.push(rec.normal || 0);
                overtimeHours.push(rec.overtime || 0);
                weekendHours.push(rec.weekend || 0);
                totalHours.push((rec.normal || 0) + (rec.overtime || 0) + (rec.weekend || 0));
            }
            
            monthHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: '正班工时',
                        data: normalHours,
                        backgroundColor: '#4caf50',
                        borderWidth: 0
                    }, {
                        label: '加班工时',
                        data: overtimeHours,
                        backgroundColor: '#ff9800',
                        borderWidth: 0
                    }, {
                        label: '周末加班',
                        data: weekendHours,
                        backgroundColor: '#e91e63',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '工时 (小时)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每日工时分布'
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    const index = tooltipItems[0].dataIndex;
                                    return `总工时: ${totalHours[index]}小时`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /* 渲染年度趋势图 */
        function renderYearTrendChart() {
            // 销毁旧图表
            if (yearTrendChart) {
                yearTrendChart.destroy();
            }
            
            const ctx = document.getElementById('yearTrendChart').getContext('2d');
            
            // 获取当前年每个月的统计数据
            const monthLabels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthlyHours = [];
            const monthlySalary = [];
            
            for (let m=0; m<12; m++) {
                const stats = getMonthStats(currentYear, m);
                monthlyHours.push(stats.normalHours + stats.overtimeHours + stats.weekendHours);
                monthlySalary.push(stats.salary);
            }
            
            yearTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: '总工时',
                        data: monthlyHours,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    }, {
                        label: '月薪总额',
                        data: monthlySalary,
                        borderColor: '#f72585',
                        backgroundColor: 'rgba(247, 37, 133, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '工时 (小时)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '薪资 (元)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentYear}年月度趋势`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y + '小时';
                                    } else {
                                        label += '¥' + context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /* 渲染工时类型饼图 */
        function renderHoursPieChart() {
            // 销毁旧图表
            if (hoursPieChart) {
                hoursPieChart.destroy();
            }
            
            const ctx = document.getElementById('hoursPieChart').getContext('2d');
            
            // 计算年度各类工时占比
            const stats = getYearStats(currentYear);
            const totalHours = stats.normalHours + stats.overtimeHours + stats.weekendHours;
            const normalPercent = totalHours > 0 ? (stats.normalHours / totalHours * 100) : 0;
            const overtimePercent = totalHours > 0 ? (stats.overtimeHours / totalHours * 100) : 0;
            const weekendPercent = totalHours > 0 ? (stats.weekendHours / totalHours * 100) : 0;
            
            // 计算各类工时的薪资
            const salaryByType = [0, 0, 0]; // [正班, 加班, 周末加班]
            Object.entries(records).forEach(([date, rec]) => {
                if (date.startsWith(currentYear)) {
                    salaryByType[0] += (rec.normal || 0) * (rec.hourlyWage || 80);
                    salaryByType[1] += (rec.overtime || 0) * (rec.hourlyWage || 80);
                    salaryByType[2] += (rec.weekend || 0) * (rec.hourlyWage || 80);
                }
            });
            
            hoursPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正班工时', '加班工时', '周末加班'],
                    datasets: [{
                        data: [stats.normalHours, stats.overtimeHours, stats.weekendHours],
                        backgroundColor: [
                            '#4caf50',
                            '#ff9800ef',
                            '#e91e63'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '工时类型分布'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percent = [normalPercent, overtimePercent, weekendPercent][context.dataIndex].toFixed(1);
                                    return `${label}: ${value}小时 (${percent}%)`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const labels = ['正班工时', '加班工时', '周末加班'];
                            const hours = [stats.normalHours, stats.overtimeHours, stats.weekendHours];
                            const totalHours = stats.normalHours + stats.overtimeHours + stats.weekendHours;
                            const totalSalary = stats.salary;
                            
                            // 计算工时占比
                            const hoursPercent = (hours[index] / totalHours * 100).toFixed(1);
                            
                            // 计算薪资占比
                            const salaryPercent = (salaryByType[index] / totalSalary * 100).toFixed(1);
                            
                            // 计算平均时薪
                            const avgHourly = hours[index] > 0 ? (salaryByType[index] / hours[index]).toFixed(2) : 0;
                            
                            // 计算该类型打卡天数
                            let days = 0;
                            Object.entries(records).forEach(([date, rec]) => {
                                if (date.startsWith(currentYear)) {
                                    if (index === 0 && rec.normal > 0) days++;
                                    if (index === 1 && rec.overtime > 0) days++;
                                    if (index === 2 && rec.weekend > 0) days++;
                                }
                            });
                            
                            // 更新图表详情
                            chartDetail = {
                                type: labels[index],
                                hours: hours[index],
                                salary: salaryByType[index],
                                days: days,
                                hoursPercent: hoursPercent,
                                salaryPercent: salaryPercent,
                                avgHourly: avgHourly
                            };
                            
                            // 显示详情模态框
                            showChartDetail();
                        }
                    }
                }
            });
        }
        
        /* 显示图表详情 */
        function showChartDetail() {
            document.getElementById('detailType').textContent = chartDetail.type;
            document.getElementById('detailHours').textContent = chartDetail.hours;
            document.getElementById('detailHoursPercent').textContent = chartDetail.hoursPercent + '%';
            document.getElementById('detailSalary').textContent = '¥' + chartDetail.salary.toFixed(2);
            document.getElementById('detailSalaryPercent').textContent = chartDetail.salaryPercent + '%';
            document.getElementById('detailAvgHourly').textContent = '¥' + chartDetail.avgHourly;
            document.getElementById('detailDays').textContent = chartDetail.days;
            
            openModal('chartDetailModal');
        }

        /* 渲染快捷列表 */
        function renderShortcuts() {
            const list = document.getElementById('shortcutList');
            list.innerHTML='';
            if(shortcuts.length===0){
                list.innerHTML='<div style="text-align:center;color:var(--gray);padding:20px;">暂无快捷，点击下方"添加"创建</div>';
                return;
            }
            shortcuts.forEach((s,idx)=>{
                const div=document.createElement('div');
                div.className='shortcut-item';
                div.innerHTML=`
                    <div>
                        <strong>${s.name}</strong><br>
                        <small>正班:${s.normal}h 加班:${s.overtime}h 周末:${s.weekend}h 时薪:¥${s.wage}</small>
                    </div>
                    <button class="del-shortcut" data-idx="${idx}"><i class="fas fa-times"></i></button>
                `;
                div.addEventListener('click',(e)=>{
                    if(!e.target.closest('.del-shortcut')){
                        // 使用该快捷
                        const str = formatDate(selectedDate);
                        records[str] = {
                            normal: s.normal,
                            overtime: s.overtime,
                            weekend: s.weekend,
                            hourlyWage: s.wage
                        };
                        saveAll();
                        renderAll();
                        closeModal('punchModal');
                    }
                });
                list.appendChild(div);
            });
            // 删除快捷
            list.querySelectorAll('.del-shortcut').forEach(btn=>{
                btn.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    shortcuts.splice(parseInt(btn.dataset.idx),1);
                    saveAll();
                    renderShortcuts();
                });
            });
        }

        /* 渲染批量打卡快捷列表 */
        function renderBatchShortcuts() {
            const list = document.getElementById('batchShortcutList');
            list.innerHTML='';
            if(shortcuts.length===0){
                list.innerHTML='<div style="text-align:center;color:var(--gray);padding:20px;">暂无快捷，请先添加快捷打卡</div>';
                return;
            }
            shortcuts.forEach((s,idx)=>{
                const div=document.createElement('div');
                div.className='shortcut-item';
                div.innerHTML=`
                    <div>
                        <strong>${s.name}</strong><br>
                        <small>正班:${s.normal}h 加班:${s.overtime}h 周末:${s.weekend}h 时薪:¥${s.wage}</small>
                    </div>
                `;
                div.addEventListener('click',()=>{
                    applyBatchPunch(s);
                });
                list.appendChild(div);
            });
        }

        /* 获取统计 */
        function getMonthStats(year, month){
            let days=0, normal=0, over=0, week=0, total=0;
            const daysInMonth = new Date(year, month+1, 0).getDate();
            for(let d=1; d<=daysInMonth; d++){
                const rec = records[formatDate(new Date(year, month, d))];
                if(rec){
                    days++;
                    normal += rec.normal||0;
                    over   += rec.overtime||0;
                    week   += rec.weekend||0;
                    total  += calculateDaily(rec);
                }
            }
            return {days, normalHours:normal, overtimeHours:over, weekendHours:week, salary:total};
        }
        function getYearStats(year){
            let days=0, normal=0, over=0, week=0, total=0;
            Object.entries(records).forEach(([date,rec])=>{
                if(date.startsWith(year)){
                    days++;
                    normal += rec.normal||0;
                    over   += rec.overtime||0;
                    week   += rec.weekend||0;
                    total  += calculateDaily(rec);
                }
            });
            return {days, normalHours:normal, overtimeHours:over, weekendHours:week, salary:total};
        }

        /* 计算日薪 */
        function calculateDaily(rec){
            return ((rec.normal||0)+(rec.overtime||0)+(rec.weekend||0)) * (rec.hourlyWage||80);
        }

        /* 统一刷新 */
        function renderAll(){
            renderCalendar(currentYear, currentMonth);
            renderYearView();
            renderDataPreview();
            renderStats();
            renderShortcuts();
        }

        /* 模态框 */
        function openPunchModal(date, rec) {
            selectedDate = new Date(date);
            document.getElementById('modalDate').textContent = `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日`;
            // 手动标签
            document.getElementById('normalHours').value = rec ? rec.normal || 0 : 8;
            document.getElementById('overtimeHours').value = rec ? rec.overtime || 0 : 0;
            document.getElementById('weekendHours').value = rec ? rec.weekend || 0 : 0;
            document.getElementById('hourlyWage').value = rec ? rec.hourlyWage || 80 : 80;
            openModal('punchModal');
        }
        function openModal(id){ 
            document.getElementById(id).classList.add('active'); 
            document.body.classList.add('modal-open');
        }
        function closeModal(id){ 
            document.getElementById(id).classList.remove('active'); 
            document.body.classList.remove('modal-open');
        }

        /* 视图切换 */
        function switchView(view){
            document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.view===view));
            ['monthView','yearView','dataView','statsView'].forEach(id=>{
                document.getElementById(id).style.display = id===view+'View'?'block':'none';
            });
            if(view==='data') renderDataPreview();
            if(view==='stats') renderStats();
            if(view==='year') renderYearView();
        }

        /* 事件绑定 */
        function setupEventListeners(){
            /* 顶部标签切换 */
            document.querySelectorAll('.tab').forEach(tab=>{
                tab.addEventListener('click',()=>switchView(tab.dataset.view));
            });

            /* 月份翻页 */
            document.getElementById('prevMonth').addEventListener('click',()=>{
                currentMonth--;
                if(currentMonth<0){currentMonth=11;currentYear--;}
                renderCalendar(currentYear, currentMonth);
            });
            document.getElementById('nextMonth').addEventListener('click',()=>{
                currentMonth++;
                if(currentMonth>11){currentMonth=0;currentYear++;}
                renderCalendar(currentYear, currentMonth);
            });
            document.getElementById('todayBtn').addEventListener('click',()=>{
                currentDate = new Date();
                currentYear = currentDate.getFullYear();
                currentMonth = currentDate.getMonth();
                renderCalendar(currentYear, currentMonth);
            });

            /* 批量打卡功能 */
            document.getElementById('batchBtn').addEventListener('click', () => {
                if (batchMode) {
                    exitBatchMode();
                } else {
                    enterBatchMode();
                }
            });
            document.getElementById('batchCancel').addEventListener('click', exitBatchMode);
            document.getElementById('batchSelectAll').addEventListener('click', () => {
                const days = document.querySelectorAll('.day:not(.other-month)');
                days.forEach(day => {
                    const dateText = day.querySelector('div:first-child').textContent;
                    const date = new Date(currentYear, currentMonth, parseInt(dateText));
                    const dateStr = formatDate(date);
                    
                    if (!day.classList.contains('other-month')) {
                        day.classList.add('batch-selected');
                        selectedDates.add(dateStr);
                    }
                });
                document.getElementById('selectedCount').textContent = selectedDates.size;
            });
            document.getElementById('batchApply').addEventListener('click', () => {
                if (selectedDates.size === 0) {
                    alert('请先选择要打卡的日期');
                    return;
                }
                renderBatchShortcuts();
                openModal('batchModal');
            });
            document.getElementById('cancelBatch').addEventListener('click', () => closeModal('batchModal'));

            /* 模态框关闭 */
            document.getElementById('cancelPunch').addEventListener('click',()=>closeModal('punchModal'));
            document.getElementById('cancelQuick').addEventListener('click',()=>closeModal('quickModal'));
            document.getElementById('cancelImport').addEventListener('click',()=>closeModal('importModal'));
            document.getElementById('closeChartDetail').addEventListener('click',()=>closeModal('chartDetailModal'));

            /* 手动保存 */
            document.getElementById('savePunch').addEventListener('click',()=>{
                const str = formatDate(selectedDate);
                const n = parseFloat(document.getElementById('normalHours').value)||0;
                const o = parseFloat(document.getElementById('overtimeHours').value)||0;
                const w = parseFloat(document.getElementById('weekendHours').value)||0;
                const h = parseFloat(document.getElementById('hourlyWage').value)||80;
                records[str] = {normal:n,overtime:o,weekend:w,hourlyWage:h};
                saveAll();
                renderAll();
                closeModal('punchModal');
            });

            /* 添加快捷 */
            document.getElementById('tabQuick').addEventListener('click',()=>openModal('quickModal'));
            document.getElementById('saveQuick').addEventListener('click',()=>{
                const name=document.getElementById('quickName').value.trim();
                if(!name){alert('请输入名称');return;}
                shortcuts.push({
                    name,
                    normal:parseFloat(document.getElementById('quickNormal').value)||0,
                    overtime:parseFloat(document.getElementById('quickOvertime').value)||0,
                    weekend:parseFloat(document.getElementById('quickWeekend').value)||0,
                    wage:parseFloat(document.getElementById('quickWage').value)||80
                });
                saveAll();
                renderShortcuts();
                closeModal('quickModal');
                // 重置输入
                document.getElementById('quickName').value='';
                document.getElementById('quickNormal').value=8;
                document.getElementById('quickOvertime').value=0;
                document.getElementById('quickWeekend').value=0;
                document.getElementById('quickWage').value=80;
            });

            /* 模态框内部标签切换 */
            document.querySelectorAll('.tab-inner').forEach(tab=>{
                tab.addEventListener('click',()=>{
                    document.querySelectorAll('.tab-inner').forEach(t=>t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab+'Content').classList.add('active');
                });
            });

            /* 导出/导入/清除 */
            document.getElementById('exportCsv').addEventListener('click',()=>exportFile('csv'));
            document.getElementById('exportJson').addEventListener('click',()=>exportFile('json'));
            document.getElementById('importJson').addEventListener('click',()=>openModal('importModal'));
            document.getElementById('clearRecords').addEventListener('click',()=>{
                if(confirm('确认清除全部记录？不可恢复！')){
                    records={};
                    saveAll();
                    renderAll();
                }
            });
            document.getElementById('importFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('importFileName').textContent = file.name;
                } else {
                    document.getElementById('importFileName').textContent = '未选择文件';
                }
            });
            document.getElementById('confirmImport').addEventListener('click', () => {
                const file = document.getElementById('importFile').files[0];
                if (!file) {
                    alert('请先选择要导入的 JSON 文件');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        records = importedData.reduce((acc, item) => {
                            acc[item['日期']] = {
                                normal: parseFloat(item['正班工时'] || 0),
                                overtime: parseFloat(item['加班工时'] || 0),
                                weekend: parseFloat(item['周末加班工时'] || 0),
                                hourlyWage: parseFloat(item['时薪'] || 80)
                            };
                            return acc;
                        }, {});
                        saveAll();
                        renderAll();
                        closeModal('importModal');
                        alert('导入成功！');
                    } catch (error) {
                        console.error('解析 JSON 错误:', error);
                        alert('导入失败，请检查文件格式是否正确');
                    }
                };
                reader.readAsText(file);
            });

            /* 底部按钮 */
            document.getElementById('tabCalendar').addEventListener('click',()=>{
                document.querySelectorAll('.action-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tabCalendar').classList.add('active');
                switchView('month');
            });
            document.getElementById('tabQuick').addEventListener('click',()=>{
                document.querySelectorAll('.action-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tabQuick').classList.add('active');
                const now = new Date();
                selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                openModal('quickModal');
            });
        }

        /* 导出文件 */
        function exportFile(type){
            const data = Object.entries(records).map(([date,rec])=>({
                日期:date,
                正班工时:rec.normal||0,
                加班工时:rec.overtime||0,
                周末加班工时:rec.weekend||0,
                时薪:rec.hourlyWage||80,
                日薪:calculateDaily(rec)
            }));
            if(type==='csv'){
                const csv = Papa.unparse(data,{header:true});
                downloadBlob(csv,'工时打卡.csv','text/csv;charset=utf-8;');
            }else{
                downloadBlob(JSON.stringify(data,null,2),'工时打卡.json','application/json;charset=utf-8;');
            }
        }
        function downloadBlob(content,filename,type){
            const blob=new Blob([type.includes('csv')?'\uFEFF'+content:content],{type});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
